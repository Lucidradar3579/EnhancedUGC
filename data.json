import requests
import json
import os

# ==== CONFIGURATION ====
API_KEY = os.getenv("EQlpgpC4UUiCC8mWFTZoz0+lG8RvCbf//Dkkvi4tpqL+H0QCZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkluTnBaeTB5TURJeExUQTNMVEV6VkRFNE9qVXhPalE1V2lJc0luUjVjQ0k2SWtwWFZDSjkuZXlKaGRXUWlPaUpTYjJKc2IzaEpiblJsY201aGJDSXNJbWx6Y3lJNklrTnNiM1ZrUVhWMGFHVnVkR2xqWVhScGIyNVRaWEoyYVdObElpd2lZbUZ6WlVGd2FVdGxlU0k2SWtWUmJIQm5jRU0wVlZWcFEwTTRiVmRHVkZwdmVqQXJiRWM0VW5aRFltWXZMMFJyYTNacE5IUndjVXdyU0RCUlF5SXNJbTkzYm1WeVNXUWlPaUkwTmpNek5qQTJNVGtpTENKbGVIQWlPakUzTlRnNE5EYzNNamdzSW1saGRDSTZNVGMxT0RnME5ERXlPQ3dpYm1KbUlqb3hOelU0T0RRME1USTRmUS5oRE1KeWQ2V3R6R3V1bUwwd2hDT1cwVW9zY1pZU1NHXzQySjhzdF9xNVRwOTQtN19RVGtvQXBhdWJDN0FGUHg4VlU5dkZXeXEwTE9sS2o5MC1qeFlrM1NETjhvM3RPZ2ltX1gzQmEwYjVVcVZUazJoNDlDSS1OTjhPcmNPcjViOEdVaXBCYk5EWG1YNEYtSDJDWXppZTB4UE5FNEVobExCREd3Qm40Q2NXOHR3SjYyM20tRzNVZ200U3ExV0wzU0gzc3FiRV9ORnFjQkhqRWFZekNFRlpHMVZ6U0cxcVRHRDNSMHpVb2FfZVBQNHJ4YXRzSXFYZ0JFRGZaME1GU2N3Mk9zOGVOUkZfOF9QWVl6LW1nNGxmYUVFTnI3eW1BS2lEYWZwdWI0ZGw0SVlvZ2Z3Y0RaVU5wdDhyZ1laMnJKUlZkSVB0WjF1R0UzSDBhbkpUTjRBZFE=")  # Set this in your environment variables
DATA_FILE = "data.json"

# UGC items with dev owners
items = {
    "463966667": {"dev": "Cain", "name": "Scarlet Witch Crown", "thumbnail": ""},
    "463966668": {"dev": "Cain", "name": "Lady Death Crown", "thumbnail": ""},
    "204792413": {"dev": "Leo", "name": "Magic Play", "thumbnail": ""},
    "204792414": {"dev": "Leo", "name": "Dreamwalking", "thumbnail": ""},
    "345678901": {"dev": "Charl", "name": "Sparkly Cape", "thumbnail": ""}
}

# Initialize earnings
earnings = {"Cain": 0, "Leo": 0, "Charl": 0}

# Function to fetch sales for a UGC item
def get_ugc_sales(item_id):
    url = f"https://apis.roblox.com/marketplace/v1/items/{item_id}/sales"
    headers = {"Authorization": f"Bearer {API_KEY}"}
    response = requests.get(url, headers=headers)
    if response.status_code != 200:
        print(f"Failed to get sales for {item_id}: {response.status_code}")
        return []
    return response.json()  # Returns a list of sales

# Build the data structure
item_data = {}
for item_id, info in items.items():
    sales = get_ugc_sales(item_id)
    total_robux = sum(sale.get("price", 0) for sale in sales)  # Sum Robux earned
    earnings[info["dev"]] += total_robux
    item_data[item_id] = {
        "name": info["name"],
        "dev": info["dev"],
        "thumbnail": info["thumbnail"],
        "sales_count": len(sales),
        "robux_earned": total_robux
    }

# Final JSON
data = {
    "items": item_data,
    "earnings": earnings
}

# Write to data.json
with open(DATA_FILE, "w") as f:
    json.dump(data, f, indent=4)

print("Earnings updated successfully!")
